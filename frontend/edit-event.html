<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edit Event ‚Äî Evinza</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .form-wrap { max-width:900px; margin:2.5rem auto; }
    .grid-2cols { display:grid; grid-template-columns: 1fr 300px; gap:1rem; }
    .input { width:100%; padding:0.75rem 1rem; border-radius:8px; border:1px solid #e5e7eb; }
    .muted { color:#6b7280; }
    @media (max-width:900px){ .grid-2cols{ grid-template-columns:1fr; padding:1rem } }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="logo"><div class="logo-icon">üë•</div><span>Evinza</span></a>
      <div class="nav-links">
        <a href="events.html" class="nav-link">üìÖ Events</a>
        <a href="groups.html" class="nav-link">üë• Groups</a>
        <a href="calendar.html" class="nav-link">üóìÔ∏è Calendar</a>
        <a href="create-event.html" class="btn btn-outline">+ Create</a>
        <span id="authArea">
            <a href="login.html" class="btn btn-primary">üë§ Login</a>
        </span>
      </div>
    </div>
  </nav>

  <main class="container form-wrap">
    <div class="card" style="padding:1.25rem;">
      <h1 style="margin-bottom:0.25rem;">Edit event</h1>
      <p class="muted">Update event details.</p>

      <div style="margin-top:1rem;" class="grid-2cols">
        <div>
          <label class="muted">Event title</label>
          <input id="title" class="input" placeholder="e.g., Monday JavaScript Study Group">

          <div style="display:flex; gap:.75rem; margin-top:0.75rem;">
            <div style="flex:1;">
              <label class="muted">Category</label>
              <select id="category" class="input">
                  <option value="Technology">Technology</option>
                  <option value="Music">Music</option>
                  <option value="Business">Business</option>
                  <option value="Health">Health</option>
                  <option value="Food">Food</option>
                  <option value="Art">Art</option>
                  <option value="Sports">Sports</option>
                  <option value="Travel">Travel</option>
              </select>
            </div>
            <div style="width:160px;">
              <label class="muted">Date</label>
              <input id="date" class="input" type="date">
            </div>
          </div>

          <div style="display:flex; gap:.75rem; margin-top:0.75rem;">
            <div style="flex:1;">
              <label class="muted">Time</label>
              <input id="time" class="input" type="time">
            </div>
            <div style="width:160px;">
              <label class="muted">Price</label>
              <input id="price" class="input" placeholder="Free or 20">
            </div>
          </div>

          <div style="margin-top:0.75rem;">
            <label class="muted">Location</label>
            <input id="location" class="input" placeholder="Address or 'Online'">
          </div>

          <div style="margin-top:0.75rem;">
            <label class="muted">Max attendees</label>
            <input id="maxAtt" class="input" type="number" min="1" placeholder="e.g., 50">
          </div>

          <div style="margin-top:0.75rem;">
            <label class="muted">Description</label>
            <textarea id="description" class="input" rows="6" placeholder="Give attendees a clear idea of what to expect"></textarea>
          </div>

          <div style="display:flex; gap:.5rem; margin-top:0.75rem;">
            <button id="saveBtn" class="btn btn-primary">Save changes</button>
            <a href="#" id="cancelLink" class="btn btn-outline">Cancel</a>
          </div>
        </div>

        <div>
          <div class="card" style="padding:1rem;">
            <label class="muted">Online event?</label>
            <div style="display:flex; gap:.5rem; margin-top:0.5rem;">
              <button id="isOnlineYes" class="btn btn-outline">Online</button>
              <button id="isOnlineNo" class="btn btn-outline">In-person</button>
            </div>

            <hr style="margin:0.75rem 0;">
            <label class="muted">Cover image URL</label>
            <input id="image" class="input" placeholder="https://images.unsplash.com/..." />
            
            <div style="margin-top:1rem; text-align:center;">
              <div id="previewWrap" style="border-radius:8px; overflow:hidden;">
                <img id="previewImg" src="" style="width:100%; height:160px; object-fit:cover;">
              </div>
              <p class="muted" style="margin-top:0.5rem;">Preview</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <div id="toast" class="toast" style="display:none"></div>

  <script src="api.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('id');
    let currentEvent = null;
    let isOnline = false;

    const t = (msg) => {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 2500);
    };

    // DOM refs
    const titleEl = document.getElementById('title');
    const categoryEl = document.getElementById('category');
    const dateEl = document.getElementById('date');
    const timeEl = document.getElementById('time');
    const locationEl = document.getElementById('location');
    const priceEl = document.getElementById('price');
    const maxAttEl = document.getElementById('maxAtt');
    const imageEl = document.getElementById('image');
    const descEl = document.getElementById('description');
    const previewImg = document.getElementById('previewImg');
    const cancelLink = document.getElementById('cancelLink');

    document.getElementById('isOnlineYes').addEventListener('click', () => { isOnline=true; t('Marked online'); });
    document.getElementById('isOnlineNo').addEventListener('click', () => { isOnline=false; t('Marked in-person'); });

    imageEl.addEventListener('input', (e) => {
      previewImg.src = e.target.value || 'https://via.placeholder.com/800x400';
    });

    async function init() {
        // Check auth
        const token = localStorage.getItem('token');
        if (token) {
            const authArea = document.getElementById('authArea');
            if(authArea) authArea.innerHTML = `<a href="profile.html" class="btn btn-primary">üë§ Profile</a>`;
        } else {
            t('Please login');
            setTimeout(() => location.href = 'login.html', 1000);
            return;
        }

        if (!eventId) {
            t('No event ID');
            return;
        }

        try {
            currentEvent = await api.events.getById(eventId);
            renderEvent(currentEvent);
            cancelLink.href = `event-detail.html?id=${eventId}`;
        } catch (error) {
            console.error(error);
            t('Failed to load event');
        }
    }

    function renderEvent(event) {
        titleEl.value = event.title;
        categoryEl.value = event.category || 'Technology';
        dateEl.value = event.date ? new Date(event.date).toISOString().split('T')[0] : '';
        timeEl.value = event.time;
        locationEl.value = event.location;
        priceEl.value = event.price;
        maxAttEl.value = event.maxAttendees;
        imageEl.value = event.image;
        descEl.value = event.description;
        isOnline = event.isOnline;
        previewImg.src = event.image || 'https://via.placeholder.com/800x400';
    }

    document.getElementById('saveBtn').addEventListener('click', async () => {
        const title = titleEl.value.trim();
        const date = dateEl.value;
        if (!title || !date) { t('Title and date are required'); return; }

        try {
            await api.events.update(eventId, {
                title,
                category: categoryEl.value,
                date,
                time: timeEl.value,
                location: locationEl.value,
                price: parseFloat(priceEl.value) || 0,
                maxAttendees: parseInt(maxAttEl.value) || 50,
                image: imageEl.value,
                description: descEl.value,
                isOnline
            });
            t('Event updated');
            setTimeout(() => window.location.href = `event-detail.html?id=${eventId}`, 1000);
        } catch (error) {
            console.error(error);
            t(error.message || 'Update failed');
        }
    });

    init();
  </script>
</body>
</html>