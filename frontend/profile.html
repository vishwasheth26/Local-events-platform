<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile ‚Äî Evinza</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .profile-wrap { max-width: 1100px; margin: 2.5rem auto; display: grid; grid-template-columns: 300px 1fr; gap: 1.5rem; align-items:start; }
    .avatar { width:100%; height:280px; object-fit:cover; border-radius:12px; }
    .badge { margin-top:0.5rem; display:inline-block; }
    .muted { color:#6b7280; }
    @media (max-width:900px){ .profile-wrap{ grid-template-columns: 1fr; padding:1rem } }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="logo">
        <div class="logo-icon">üë•</div>
        <span>Evinza</span>
      </a>
      <button class="mobile-menu-btn" onclick="toggleMenu()">‚ò∞</button>

      <div class="nav-links" id="mobileMenu">
        <a href="events.html" class="nav-link">üìÖ Events</a>
        <a href="groups.html" class="nav-link">üë• Groups</a>
        <a href="calendar.html" class="nav-link">üóìÔ∏è Calendar</a>

        <a href="create-event.html" class="btn btn-outline">+ Create Event</a>
        <span id="authArea">
            <a href="profile.html" class="btn btn-primary">üë§ Profile</a>
        </span>
      </div>
    </div>
  </nav>

  <main class="container profile-wrap">
    <aside>
      <div class="card" style="padding:1.25rem;">
        <img id="avatar" class="avatar" src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=200" alt="avatar">
        <h2 id="pname" style="margin-top:0.75rem;"></h2>
        <div id="pemail" class="muted"></div>
        <div id="plocation" class="muted" style="margin-top:0.25rem;"></div>

        <div style="margin-top:1rem;">
          <button id="editBtn" class="btn btn-outline" style="width:100%; margin-bottom:0.5rem;">Edit profile</button>
          <button id="logout" class="btn btn-primary" style="width:100%;">Logout</button>
        </div>

        <div style="margin-top:1rem;">
          <h4 style="margin-bottom:0.5rem;">Interests</h4>
          <div id="interestList" style="display:flex;flex-wrap:wrap;gap:0.5rem;"></div>
        </div>
      </div>
    </aside>

    <section>
      <div class="card" style="padding:1.25rem; margin-bottom:1rem;">
        <h3>About</h3>
        <p id="pbio" class="muted"></p>
      </div>

      <div class="card" style="padding:1.25rem; margin-bottom:1rem;">
        <h3>Upcoming / Attended events</h3>
        <div id="userEvents" style="display:grid; gap:0.75rem; margin-top:0.75rem;"></div>
      </div>

      <div class="card" style="padding:1.25rem;">
        <h3>Joined groups</h3>
        <div id="userGroups" style="display:grid; gap:0.75rem; margin-top:0.75rem;"></div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" style="display:none"></div>

  <script src="api.js"></script>
  <script>
    const t = (msg) => { const el=document.getElementById('toast'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',3000); };

    async function loadProfile() {
      try {
        const user = await api.auth.getProfile();
        renderUserInfo(user);
        
        const [eventsData, groupsData] = await Promise.all([
            api.events.getUserEvents(user.id),
            api.groups.getUserGroups(user.id)
        ]);

        renderUserEvents(eventsData);
        renderUserGroups(groupsData);

      } catch (error) {
        console.error(error);
        t('Session expired or invalid. Redirecting...');
        setTimeout(() => location.href = 'login.html', 1500);
      }
    }

    function renderUserInfo(user) {
      document.getElementById('avatar').src = user.avatar || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=200';
      document.getElementById('pname').textContent = user.name || 'Member';
      document.getElementById('pemail').textContent = user.email || '';
      document.getElementById('plocation').textContent = user.location || '';
      document.getElementById('pbio').textContent = user.bio || 'No bio yet. Edit your profile to add one.';

      const interests = user.interests || []; // Assuming interests is an array of strings
      const il = document.getElementById('interestList');
      il.innerHTML = '';
      if (interests.length === 0) {
          il.innerHTML = '<span class="muted" style="font-size:0.9rem">No interests listed</span>';
      } else {
        interests.forEach(i => {
            const s = document.createElement('span');
            s.className = 'btn btn-outline';
            s.style.fontSize='0.9rem';
            s.textContent = i;
            il.appendChild(s);
        });
      }
    }

    function renderUserEvents(data) {
        const allEvents = [...(data.organized || []), ...(data.attending || [])];
        // Deduplicate by ID just in case
        const uniqueEvents = Array.from(new Map(allEvents.map(item => [item.id, item])).values());
        
        const ue = document.getElementById('userEvents');
        if (uniqueEvents.length === 0) {
            ue.innerHTML = '<div class="muted">No events yet.</div>';
            return;
        }

        ue.innerHTML = uniqueEvents.slice(0, 6).map(e => `
            <a href="event-detail.html?id=${e.id}" class="card" style="display:flex; gap:1rem; padding:0.75rem; align-items:center;">
            <img src="${e.image||'https://images.unsplash.com/photo-1517694712202-14dd9538aa97?w=200'}" style="width:72px;height:72px;object-fit:cover;border-radius:8px;">
            <div style="flex:1;">
                <div style="font-weight:700">${e.title}</div>
                <div class="muted" style="font-size:0.9rem;">${new Date(e.date).toLocaleDateString()} ‚Ä¢ ${e.location || 'Online'}</div>
            </div>
            </a>
        `).join('');
    }

    function renderUserGroups(data) {
        const allGroups = [...(data.organized || []), ...(data.joined || [])];
        const uniqueGroups = Array.from(new Map(allGroups.map(item => [item.id, item])).values());

        const ug = document.getElementById('userGroups');
        if (uniqueGroups.length === 0) {
            ug.innerHTML = '<div class="muted">No groups joined yet.</div>';
            return;
        }

        ug.innerHTML = uniqueGroups.slice(0, 4).map(g => `
            <a href="group-detail.html?id=${g.id}" class="card" style="display:flex; gap:1rem; padding:0.75rem; align-items:center;">
            <img src="${g.image || 'https://via.placeholder.com/150'}" style="width:72px;height:72px;object-fit:cover;border-radius:8px;">
            <div>
                <div style="font-weight:700">${g.name}</div>
                <div class="muted" style="font-size:0.9rem;">${(g.members || 0).toLocaleString()} members</div>
            </div>
            </a>
        `).join('');
    }

    document.getElementById('logout').addEventListener('click', ()=>{
      localStorage.removeItem('token');
      localStorage.removeItem('user'); // Clear any other legacy storage
      t('Logged out'); 
      setTimeout(()=> location.href='index.html', 700);
    });

    loadProfile();
  </script>
</body>
</html>
