<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - Evinza</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <div class="logo-icon">ğŸ‘¥</div>
                <span>Evinza</span>
            </a>
            <button class="mobile-menu-btn" onclick="toggleMenu()">â˜°</button>

            <div class="nav-links" id="mobileMenu">
                <a href="events.html" class="nav-link">ğŸ“… Events</a>
                <a href="groups.html" class="nav-link">ğŸ‘¥ Groups</a>
                <a href="calendar.html" class="nav-link">ğŸ—“ï¸ Calendar</a>

                <a href="create-event.html" class="btn btn-outline">+ Create Event</a>
                <span id="authArea">
                    <a href="login.html" class="btn btn-primary">ğŸ‘¤ Login</a>
                </span>
            </div>
        </div>
    </nav>

    <div style="position: relative; height: 400px; background: #111;">
        <img id="eventImage" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.8;" alt="Event cover">
        <div style="position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);"></div>
        <button onclick="history.back()" class="btn" style="position: absolute; top: 1rem; left: 1rem; background: white; color: #111;">â† Back</button>
        <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 2rem;">
            <div class="container">
                <span id="eventCategory" style="background: white; color: #111; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.875rem; font-weight: 600;"></span>
                <h1 id="eventTitle" style="font-size: 3rem; font-weight: bold; color: white; margin: 1rem 0;"></h1>
                <p style="color: rgba(255,255,255,0.9);">Hosted by <span id="eventOrganizer"></span></p>
            </div>
        </div>
    </div>

    <div class="container" style="padding: 2rem 1rem;">
       <div class="event-detail-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <div>
                <div class="card" style="padding: 2rem; margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem;">Event Details</h2>
                    <div id="eventDetails"></div>
                </div>

                <div class="card" style="padding: 2rem;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">About this event</h2>
                    <p id="eventDescription" style="color: #374151; line-height: 1.8;"></p>
                </div>
            </div>

            <div>
                <div class="card" style="padding: 1.5rem; margin-bottom: 1rem;">
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;" id="eventPrice"></div>

                    <!-- RSVP / Edit / Delete buttons -->
                    <div style="display: flex; gap: .5rem; margin-bottom: .75rem;">
                      <button id="rsvpBtn" class="btn btn-primary" style="flex: 1;">Attend</button>
                      <button id="editBtn" class="btn btn-outline" style="display:none;">Edit</button>
                      <button id="deleteBtn" class="btn btn-outline" style="display:none; background:#fee2e2; color:#991b1b;">Delete</button>
                    </div>

                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-outline" style="flex: 1;" onclick="toggleSave()">â¤ï¸</button>
                        <button class="btn btn-outline" style="flex: 1;" onclick="shareEvent()">ğŸ”—</button>
                    </div>
                </div>

                <div class="card" style="padding: 1.5rem;">
                    <h3 style="font-weight: bold; margin-bottom: 1rem;">Attendees</h3>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Attending</span>
                        <strong id="attendeeCount"></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <span>Capacity</span>
                        <strong id="maxAttendees"></strong>
                    </div>
                    <div style="height: 8px; background: #e5e7eb; border-radius: 999px; overflow: hidden;">
                        <div id="attendeeBar" style="height: 100%; background: linear-gradient(to right, #2563eb, #7c3aed); width:0%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast" style="display:none;"></div>

    <script src="http://localhost:4000/socket.io/socket.io.js"></script>
    <script src="api.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        let currentEvent = null;
        let currentUser = null;

        const t = (msg) => {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 2500);
        };

        async function init() {
            try {
                // Check auth
                const token = localStorage.getItem('token');
                if (token) {
                    try {
                        currentUser = JSON.parse(localStorage.getItem('user'));
                        // Update auth area
                         const authArea = document.getElementById('authArea');
                         if(authArea) {
                             authArea.innerHTML = `<a href="profile.html" class="btn btn-primary">ğŸ‘¤ Profile</a>`;
                         }
                    } catch(e) {}
                }

                // Fetch event
                currentEvent = await api.events.getById(eventId);
                renderEvent(currentEvent);

                // Setup buttons
                setupButtons();

            } catch (error) {
                console.error(error);
                t('Failed to load event');
            }
        }

        function renderEvent(event) {
            document.getElementById('eventImage').src = event.image || 'https://images.unsplash.com/photo-1501281668745-f7f57925c3b4?w=1200';
            document.getElementById('eventCategory').textContent = event.category || 'Event';
            document.getElementById('eventTitle').textContent = event.title;
            document.getElementById('eventOrganizer').textContent = event.organizer ? event.organizer.name : 'Unknown';
            document.getElementById('eventDescription').textContent = event.description;
            document.getElementById('eventPrice').textContent = event.price > 0 ? `$${event.price}` : 'Free';
            
            const attendeesCount = event.attendees ? event.attendees.length : 0; // Or event.attendeesCount if backend provided it
            // Note: backend getEventById includes attendees array.
            
            document.getElementById('attendeeCount').textContent = attendeesCount;
            document.getElementById('maxAttendees').textContent = event.maxAttendees || 50;
            
            const percent = (attendeesCount / (event.maxAttendees || 50)) * 100;
            document.getElementById('attendeeBar').style.width = `${Math.min(100, percent)}%`;

            document.getElementById('eventDetails').innerHTML = `
                <div style="display:flex; gap:1rem; margin-bottom:1rem;">
                  <div style="width:48px;height:48px;background:#eff6ff;border-radius:12px;display:flex;align-items:center;justify-content:center;">
                    <span style="font-size:1.5rem;">ğŸ“…</span>
                  </div>
                  <div>
                    <p style="font-weight:600;">${new Date(event.date).toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' })}</p>
                    <p style="color:#6b7280;">${event.time || 'â€”'}</p>
                  </div>
                </div>
                <div style="display:flex; gap:1rem; margin-bottom:1rem;">
                  <div style="width:48px;height:48px;background:#f0fdf4;border-radius:12px;display:flex;align-items:center;justify-content:center;">
                    <span style="font-size:1.5rem;">ğŸ“</span>
                  </div>
                  <div>
                    <p style="font-weight:600;">${event.isOnline ? 'Online' : (event.location || 'â€”')}</p>
                    <p style="color:#6b7280;">${event.isOnline ? 'Online event' : 'In-person event'}</p>
                  </div>
                </div>
            `;

            // Check permissions
            if (currentUser && (currentUser.id === event.organizerId || currentUser.role === 'admin')) {
                document.getElementById('editBtn').style.display = 'inline-block';
                document.getElementById('deleteBtn').style.display = 'inline-block';
            }

            // Check RSVP status
            if (currentUser && event.attendees) {
                const isAttending = event.attendees.some(a => a.id === currentUser.id);
                const rsvpBtn = document.getElementById('rsvpBtn');
                if (isAttending) {
                    rsvpBtn.textContent = "You're attending";
                    rsvpBtn.style.background = '#10b981';
                    rsvpBtn.onclick = () => handleRSVP('not_going');
                } else {
                    rsvpBtn.textContent = "Attend";
                    rsvpBtn.style.background = '';
                    rsvpBtn.onclick = () => handleRSVP('going');
                }
            } else if (!currentUser) {
                document.getElementById('rsvpBtn').onclick = () => {
                    t('Please login to attend');
                    setTimeout(() => location.href = 'login.html', 1000);
                };
            }
        }

        async function handleRSVP(status) {
            try {
                await api.events.rsvp(eventId, status);
                t(status === 'going' ? 'RSVP Confirmed!' : 'RSVP Cancelled');
                // Reload to update state
                init();
            } catch (error) {
                console.error(error);
                t('RSVP failed');
            }
        }

        function setupButtons() {
            document.getElementById('deleteBtn').onclick = async () => {
                if(confirm('Are you sure you want to delete this event?')) {
                    try {
                        await api.events.delete(eventId);
                        t('Event deleted');
                        setTimeout(() => location.href = 'events.html', 1000);
                    } catch (error) {
                        console.error(error);
                        t('Failed to delete event');
                    }
                }
            };
            
            document.getElementById('editBtn').onclick = () => {
                window.location.href = `edit-event.html?id=${eventId}`;
            };
        }

        function toggleSave() {
            // Local storage for saved events (bookmarks)
            let saved = JSON.parse(localStorage.getItem('savedEvents') || '[]');
            if (saved.includes(eventId)) {
                saved = saved.filter(id => id !== eventId);
                t('Removed from saved');
            } else {
                saved.push(eventId);
                t('Event saved!');
            }
            localStorage.setItem('savedEvents', JSON.stringify(saved));
        }

        function shareEvent() {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(window.location.href).then(() => t('Link copied!'));
            } else {
                t('Copy the URL from the address bar');
            }
        }

        // Real-time updates
        if (window.api && window.api.socket) {
            window.api.socket.on('event:update', (data) => {
                if (data.eventId == eventId) {
                    // Refresh data
                    init();
                }
            });
        }

        init();
    </script>
</body>
</html>